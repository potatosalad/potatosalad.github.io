<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="https://potatosalad.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://potatosalad.io/" rel="alternate" type="text/html" /><updated>2020-06-30T16:05:39-05:00</updated><id>https://potatosalad.io/feed.xml</id><title type="html">potatosalad</title><subtitle>The Development Blog of Andrew Bennett
</subtitle><author><name>Andrew Bennett</name></author><entry><title type="html">Time-Out: Elixir State Machines versus Servers</title><link href="https://potatosalad.io/2017/10/13/time-out-elixir-state-machines-versus-servers" rel="alternate" type="text/html" title="Time-Out: Elixir State Machines versus Servers" /><published>2017-10-13T00:00:00-05:00</published><updated>2017-10-13T00:00:00-05:00</updated><id>https://potatosalad.io/2017/10/13/time-out-elixir-state-machines-versus-servers</id><content type="html" xml:base="https://potatosalad.io/2017/10/13/time-out-elixir-state-machines-versus-servers">&lt;p&gt;I love &lt;a href=&quot;http://erlang.org/doc/man/gen_statem.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt;&lt;/a&gt; (and the Elixir wrapper &lt;a href=&quot;https://github.com/antipax/gen_state_machine&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_state_machine&lt;/code&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Prior to the addition of &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; in OTP 19, the decision of when to use &lt;a href=&quot;http://erlang.org/doc/man/gen_server.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;http://erlang.org/doc/man/gen_fsm.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_fsm&lt;/code&gt;&lt;/a&gt; was a carefully considered one.  In the vast majority of my use cases, a simple &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt; was the easiest solution; even if it technically was behaving as a state machine.&lt;/p&gt;

&lt;p&gt;Initially, I thought of &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; only as a &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_fsm&lt;/code&gt; replacement and assumed I would rarely need it over using &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Lately, however, I find myself reaching for &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; to solve problems that I would have previously solved with &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt; Try using &lt;a href=&quot;http://erlang.org/doc/man/gen_statem.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt;&lt;/a&gt; instead of &lt;a href=&quot;http://erlang.org/doc/man/gen_server.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt;&lt;/a&gt; (especially if you plan on using &lt;a href=&quot;http://erlang.org/doc/man/erlang.html#start_timer-3&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;:erlang.start_timer/3&lt;/code&gt;&lt;/a&gt;).  You may find it’s a better fit than you think.&lt;/p&gt;

&lt;h2 id=&quot;comparison&quot;&gt;Comparison&lt;/h2&gt;

&lt;p&gt;Quick comparison between &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt;, using the &lt;code class=&quot;highlighter-rouge&quot;&gt;Stack&lt;/code&gt; example in Elixir’s &lt;a href=&quot;https://hexdocs.pm/elixir/GenServer.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;GenServer&lt;/code&gt;&lt;/a&gt; documentation.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; I’m going to use the actual Erlang behaviours instead of Elixir’s &lt;a href=&quot;https://hexdocs.pm/elixir/GenServer.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;GenServer&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/antipax/gen_state_machine&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;GenStateMachine&lt;/code&gt;&lt;/a&gt; so that more details are present.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;StackServer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_cast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:noreply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Start the server&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;StackServer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:hello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This is the client&lt;/span&gt;
&lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :hello&lt;/span&gt;

&lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:world&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :ok&lt;/span&gt;

&lt;span class=&quot;ss&quot;&gt;:gen_server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :world&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Pretty simple, right?  Let’s see how &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; compares.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; OTP’s &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; has 2 major modes of operation, but for the purpose of this article, only &lt;code class=&quot;highlighter-rouge&quot;&gt;:handle_event_function&lt;/code&gt; will be covered.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;StackStateMachine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;callback_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;:handle_event_function&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:keep_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:cast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:keep_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Start the server&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;StackStateMachine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:hello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# This is the client&lt;/span&gt;
&lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :hello&lt;/span&gt;

&lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:world&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :ok&lt;/span&gt;

&lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:pop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;#=&amp;gt; :world&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, the state is &lt;code class=&quot;highlighter-rouge&quot;&gt;nil&lt;/code&gt; and is not used.&lt;/p&gt;

&lt;p&gt;You’ll notice that instead of a &lt;code class=&quot;highlighter-rouge&quot;&gt;{:reply, _, _}&lt;/code&gt; callback tuple as used in &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt;, replies are sent by passing “actions” as the last element of the state callback tuple.  Replies (one or more) can be sent at any time and not necessarily as a synchronous operation resulting from a call event.&lt;/p&gt;

&lt;p&gt;Functionally, both examples are equivalent and some may argue that the more concise &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_server&lt;/code&gt; implementation is objectively better than the &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; version.  However, &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; really begins to shine, in my opinion, as more and more complexity is added to the implementation.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Should elements of the stack expire over time?&lt;/li&gt;
  &lt;li&gt;Should certain elements be dropped after a limit has been reached?&lt;/li&gt;
  &lt;li&gt;If the stack is empty, should the call block until a new item has been pushed?&lt;/li&gt;
  &lt;li&gt;Should the call queue also expire over time?&lt;/li&gt;
  &lt;li&gt;What if all of the above is desired?&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;time-outs-for-free&quot;&gt;Time-Outs for Free&lt;/h2&gt;

&lt;p&gt;The time-out actions included in &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; are probably my favorite feature, but they took a while for me to understand.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://erlang.org/doc/design_principles/statem.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; documentation&lt;/a&gt; is excellent, but fairly information-dense and can be difficult to initially digest for some (myself included).  It took several reads for me to understand just how powerful time-out actions could be.&lt;/p&gt;

&lt;p&gt;There are 3 built-in types of time-out actions…&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Time-Out&lt;/th&gt;
      &lt;th&gt;Cancellation&lt;/th&gt;
      &lt;th&gt;Cancelled When…&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Event&lt;/td&gt;
      &lt;td&gt;Automatic&lt;/td&gt;
      &lt;td&gt;Any event handled&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;State&lt;/td&gt;
      &lt;td&gt;Automatic/Manual&lt;/td&gt;
      &lt;td&gt;Reset to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt; or state changes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Generic&lt;/td&gt;
      &lt;td&gt;Manual&lt;/td&gt;
      &lt;td&gt;Reset to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The basic types and syntax for time-outs are as follows:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Types&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generic_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generic_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:infinity&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non_neg_integer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_tuple&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;timeout_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout_term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Event Time-Out Example&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@spec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# State Time-Out Example&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@spec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Generic Time-Out Example&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;@spec&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;::&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To “reset to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt;” for state and generic time-outs, you would simply do…&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# State Time-Out Cancellation&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:infinity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Generic Time-Out Cancellation&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:any&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:infinity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;event-time-out&quot;&gt;Event Time-Out&lt;/h3&gt;

&lt;p&gt;I rarely use event time-outs due to their volatility.  &lt;em&gt;Any&lt;/em&gt; event will cancel them.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## Event Time-Out: Stop after 1 second example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Event Timeout Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;:stop&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is no way to manually cancel an event time-out.&lt;/p&gt;

&lt;p&gt;Any event handled effectively cancels the time-out…&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## Event Time-Out: Automatic cancellation example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Send a message to myself after 0.5 seconds&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;send_after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_event_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Info Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_event_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;:keep_state_and_data&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;state-time-out&quot;&gt;State Time-Out&lt;/h3&gt;

&lt;p&gt;State time-outs, however, survive any event that doesn’t reset them or change the state.&lt;/p&gt;

&lt;p&gt;For example: a connection time-out for a socket.  I might set the state to &lt;code class=&quot;highlighter-rouge&quot;&gt;:connecting&lt;/code&gt; and start the connection process which consists of many individual events.  If the state is still &lt;code class=&quot;highlighter-rouge&quot;&gt;:connecting&lt;/code&gt; after 5 seconds, I might want to change the state to &lt;code class=&quot;highlighter-rouge&quot;&gt;:disconnected&lt;/code&gt; and retry the connection process after waiting for a few seconds with another state time-out.  If it’s successful, I could change the state to &lt;code class=&quot;highlighter-rouge&quot;&gt;:connected&lt;/code&gt;, which would cancel any existing state time-outs.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## State Time-Out: Stop after 1 second example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# State Timeout Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;:stop&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are two ways to cancel a state time-out.&lt;/p&gt;

&lt;p&gt;First, setting the state time-out to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt; will cancel the time-out…&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## State Time-Out: Manual cancellation example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Send a message to myself after 0.5 seconds&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;send_after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Info Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:infinity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:keep_state_and_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Second, changing the state will cancel the time-out…&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## State Time-Out: Automatic cancellation example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Send a message to myself after 0.5 seconds&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;send_after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:unstable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Info Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:unstable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:next_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice that the initial state was &lt;code class=&quot;highlighter-rouge&quot;&gt;:unstable&lt;/code&gt; and changing to the &lt;code class=&quot;highlighter-rouge&quot;&gt;:stable&lt;/code&gt; state cancelled the state time-out.&lt;/p&gt;

&lt;p&gt;Any other events handled that do not change the state or reset the state time-out will result in a &lt;code class=&quot;highlighter-rouge&quot;&gt;:state_timeout&lt;/code&gt; event.&lt;/p&gt;

&lt;h3 id=&quot;generic-time-out&quot;&gt;Generic Time-Out&lt;/h3&gt;

&lt;p&gt;Generic time-outs survive any events or state changes and must be manually reset to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt; in order to be cancelled.&lt;/p&gt;

&lt;p&gt;For example: a request time-out, building on top of the socket connection time-out from earlier.  At the start of the request, I might set a generic time-out for 30 seconds.  I can then try multiple times to connect and reconnect until the request has actually been sent, but if it is still unsuccessful after 30 seconds, it’s time to cancel the request.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## Generic Time-Out: Stop after 1 second example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:generic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Generic Timeout Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:generic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;:stop&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The only way to cancel a generic time-out is by setting it to &lt;code class=&quot;highlighter-rouge&quot;&gt;:infinity&lt;/code&gt; in the same way that state time-outs may be cancelled…&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;## Generic Time-Out: Manual cancellation example ##&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Send a message to myself after 0.5 seconds&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;send_after&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:erlang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_generic_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:generic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:stop_after_one_second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;@impl&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:gen_statem&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Info Events&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cancel_generic_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:generic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:infinity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:keep_state_and_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;my-favorite-mode&quot;&gt;My Favorite Mode&lt;/h2&gt;

&lt;p&gt;My favorite callback mode for &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; is actually &lt;code class=&quot;highlighter-rouge&quot;&gt;[:handle_event_function, :state_enter]&lt;/code&gt;, which I would recommend for anyone who is trying to start using &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt; for problem solving.&lt;/p&gt;

&lt;p&gt;The main benefits of this callback mode are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Complex State&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;Your state can technically be any term (not just an atom), which opens up some fairly complex possibilities on what can be done with your state machine.&lt;/p&gt;

    &lt;p&gt;For example, instead of just &lt;code class=&quot;highlighter-rouge&quot;&gt;:connected&lt;/code&gt; you might have state as a tuple &lt;code class=&quot;highlighter-rouge&quot;&gt;{:connected, :heartbeat}&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;{:connected, :degraded}&lt;/code&gt;.  You can then pattern match on the state to group together events common to the &lt;code class=&quot;highlighter-rouge&quot;&gt;{:connected, _}&lt;/code&gt; state.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;State Enter Events&lt;/strong&gt;&lt;/p&gt;

    &lt;p&gt;By default, state enter events (or transition events) are not emitted by &lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt;, but I have found that they can be very useful to help reduce code complexity.  This is especially noticeable with state time-outs that need to be started immediately after changing state.&lt;/p&gt;

    &lt;p&gt;For example:&lt;/p&gt;

    &lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:enter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:disconnected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:disconnected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p&gt;This means that my &lt;code class=&quot;highlighter-rouge&quot;&gt;init/1&lt;/code&gt; callback function returned something like &lt;code class=&quot;highlighter-rouge&quot;&gt;{:ok, :disconnected, data}&lt;/code&gt;, so &lt;code class=&quot;highlighter-rouge&quot;&gt;:disconnected&lt;/code&gt; is my intial state.&lt;/p&gt;

    &lt;p&gt;I might return a &lt;code class=&quot;highlighter-rouge&quot;&gt;{:state_timeout, 0, :connect}&lt;/code&gt; to immediately attempt a connection and transition to the &lt;code class=&quot;highlighter-rouge&quot;&gt;:connecting&lt;/code&gt; state.  If that fails, I might transition back to the &lt;code class=&quot;highlighter-rouge&quot;&gt;:disconnected&lt;/code&gt; state, which would emit:&lt;/p&gt;

    &lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:enter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:connecting&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:disconnected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;

    &lt;p&gt;In this case, I might want to wait for 1 second by returning &lt;code class=&quot;highlighter-rouge&quot;&gt;{:state_timeout, 1000, :connect}&lt;/code&gt; to delay reconnecting.&lt;/p&gt;

    &lt;p&gt;Typically, I tend to combine these two cases into a single handler:&lt;/p&gt;

    &lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:enter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:disconnected&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;old_state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:disconnected&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:state_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:keep_state_and_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;actions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;In general, I have found the aforementioned callback mode to be the most versatile and useful to better solve otherwise complicated problems.&lt;/p&gt;

&lt;p&gt;Hopefully, &lt;a href=&quot;https://hexdocs.pm/gen_state_machine/GenStateMachine.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;GenStateMachine&lt;/code&gt;&lt;/a&gt; will one day be part of Elixir core and you’ll be able to write the following without any external dependencies:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyStateMachine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;GenStateMachine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;callback_mode:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:handle_event_function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:state_enter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Until then, you can use the &lt;a href=&quot;http://erlang.org/doc/man/gen_statem.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_statem&lt;/code&gt;&lt;/a&gt; behaviour directly or add &lt;a href=&quot;https://hex.pm/packages/gen_state_machine&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;gen_state_machine&lt;/code&gt;&lt;/a&gt; as a dependency to your mix file.&lt;/p&gt;</content><author><name>Andrew Bennett</name></author><category term="Elixir" /><category term="Erlang" /><category term="gen_statem" /><summary type="html">I love gen_statem (and the Elixir wrapper gen_state_machine).</summary></entry><entry><title type="html">Load Testing cowboy 2.0.0-rc.1</title><link href="https://potatosalad.io/2017/08/20/load-testing-cowboy-2-0-0-rc-1" rel="alternate" type="text/html" title="Load Testing cowboy 2.0.0-rc.1" /><published>2017-08-20T00:00:00-05:00</published><updated>2017-08-20T00:00:00-05:00</updated><id>https://potatosalad.io/2017/08/20/load-testing-cowboy-2-0-0-rc-1</id><content type="html" xml:base="https://potatosalad.io/2017/08/20/load-testing-cowboy-2-0-0-rc-1">&lt;p&gt;Let’s load test &lt;a href=&quot;https://github.com/ninenines/cowboy/releases/tag/2.0.0-rc.1&quot;&gt;cowboy 2.0.0-rc.1&lt;/a&gt; and see how it compares to &lt;a href=&quot;https://github.com/ninenines/cowboy/releases/tag/1.1.2&quot;&gt;cowboy 1.1.2&lt;/a&gt;!&lt;/p&gt;

&lt;h2 id=&quot;setup&quot;&gt;Setup&lt;/h2&gt;

&lt;p&gt;The plan is to use &lt;a href=&quot;https://nghttp2.org/documentation/h2load-howto.html&quot;&gt;h2load&lt;/a&gt; and record the current requests per second while also measuring scheduler utilization.&lt;/p&gt;

&lt;p&gt;Since h2load didn’t support this at the time of writing, there is a custom version available at &lt;a href=&quot;https://github.com/potatosalad/nghttp2/tree/elixirconf2017&quot;&gt;potatosalad/nghttp2@elixirconf2017&lt;/a&gt; which supports printing the current requests per second for a given interval.&lt;/p&gt;

&lt;p&gt;Let’s setup the two versions of cowboy we’re going to test:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/ninenines/cowboy/releases/tag/1.1.2&quot;&gt;cowboy 1.1.2&lt;/a&gt; — released 2017-02-06&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/ninenines/cowboy/releases/tag/2.0.0-rc.1&quot;&gt;cowboy 2.0.0-rc.1&lt;/a&gt; — released 2017-07-24&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; This is not a perfectly fair comparison, as cowboy 1.x is HTTP/1.1 only, while cowboy 2.x supports HTTP/2.&lt;/p&gt;

&lt;h3 id=&quot;cowboy-112&quot;&gt;cowboy 1.1.2&lt;/h3&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;ss&quot;&gt;:cowboy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;port:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29593&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;env:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;dispatch:&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cowboy_router&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]}]}])&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cowboy_http_handler&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_transport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;ss&quot;&gt;:cowboy_req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;content-type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;text/plain&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Hello world!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;terminate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_reason&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cowboy-200-rc1&quot;&gt;cowboy 2.0.0-rc.1&lt;/h3&gt;

&lt;h5 id=&quot;cowboy_handler-behaviour&quot;&gt;&lt;a href=&quot;https://ninenines.eu/docs/en/cowboy/2.0/manual/cowboy_handler/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cowboy_handler&lt;/code&gt;&lt;/a&gt; behaviour&lt;/h5&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;ss&quot;&gt;:cowboy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_clear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;port:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29593&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;env:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;dispatch:&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cowboy_router&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]}]}])&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cowboy_handler&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
      &lt;span class=&quot;ss&quot;&gt;:cowboy_req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;content-type&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;text/plain&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Hello world!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;cowboy_stream-behaviour&quot;&gt;&lt;a href=&quot;https://ninenines.eu/docs/en/cowboy/2.0/manual/cowboy_stream/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cowboy_stream&lt;/code&gt;&lt;/a&gt; behaviour&lt;/h5&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;ss&quot;&gt;:cowboy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_clear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;port:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;29593&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
  &lt;span class=&quot;ss&quot;&gt;env:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;stream_handlers:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;StreamHandler&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Contention&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;StreamHandler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;@behaviour&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cowboy_stream&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_streamid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_req&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;content-type&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;text/plain&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}},&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:fin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Hello world!&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;ss&quot;&gt;:stop&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cowboy 1.x was tested with the following command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;h2load &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--h1&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--duration&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;300 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--warm-up-time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1s &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--clients&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;100 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--requests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'http://127.0.0.1:29594/'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cowboy 2.x was tested with the following command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;h2load &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--duration&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;300 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--warm-up-time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1s &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--clients&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;100 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--max-concurrent-streams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--requests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--window-bits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;16 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--connection-window-bits&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;16 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'http://127.0.0.1:29594/'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test script used is available here:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/82d2c04338a3b273b6cdb8375d6cc2df4d80f7fa/apps/contention/priv/cowboy2/h2load.escript&quot;&gt;priv/cowboy2/h2load.escript&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;

&lt;p&gt;First, let’s test cowboy 1.x using h2load in HTTP/1.1 mode.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2.1.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2.1.svg&quot; alt=&quot;cowboy-1.1.2.1.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Not bad, an average of ~20k req/s and maximum of ~40k req/s.&lt;/p&gt;

&lt;p&gt;Second, let’s test our cowboy 2.x handler using h2load in HTTP/2 mode.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.a.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.a.svg&quot; alt=&quot;cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.a.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We have a 2x performance gain with an average of ~40k req/s and maximum of ~70k req/s.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/essen&quot;&gt;Loïc Hoguin&lt;/a&gt;, the author of cowboy, mentioned in &lt;a href=&quot;https://github.com/ninenines/cowboy/issues/1169&quot;&gt;this issue&lt;/a&gt; that using the &lt;a href=&quot;https://ninenines.eu/docs/en/cowboy/2.0/manual/cowboy_stream/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cowboy_stream&lt;/code&gt;&lt;/a&gt; behaviour should provide a little extra performance, so let’s test it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.b.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.b.svg&quot; alt=&quot;cowboy-1.1.2-vs-cowboy-2.0.0-rc.1.b.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Loïc was right!  We gained a 1.5x increase over our handler test and a 3x increase over cowboy 1.x with an average of ~60k req/s and maximum of ~90k req/s.&lt;/p&gt;

&lt;p&gt;A few months ago, I started a &lt;a href=&quot;https://github.com/potatosalad/erlang-h2o&quot;&gt;very unstable experiment&lt;/a&gt; to see if I could create a NIF library that Erlang could use to run a HTTP/2 server using &lt;a href=&quot;https://github.com/h2o/h2o&quot;&gt;libh2o&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I succeeded in creating a &lt;em&gt;very&lt;/em&gt; unstable test setup that can actually have &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/82d2c04338a3b273b6cdb8375d6cc2df4d80f7fa/apps/contention/lib/contention/h2o/handler.ex&quot;&gt;a module&lt;/a&gt; send responses back to requests received by libh2o.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1-vs-h2o-2.2.0.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2-vs-cowboy-2.0.0-rc.1-vs-h2o-2.2.0.svg&quot; alt=&quot;cowboy-1.1.2-vs-cowboy-2.0.0-rc.1-vs-h2o-2.2.0.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The average of ~280k req/s and maximum of ~400k req/s is pretty consistent with &lt;a href=&quot;https://h2o.examp1e.net/benchmarks.html&quot;&gt;h2o’s benchmark claims&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In a future post, I will explore the causes of the differences.&lt;/p&gt;

&lt;h2 id=&quot;scheduler-utilization&quot;&gt;Scheduler Utilization&lt;/h2&gt;

&lt;p&gt;For the extra curious, below are the measured scheduler utilization graphs for each of the tests.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; My explanations below are currently in “guess”-form and are not based on any hard evidence.  I plan to explore the real reasons for theses numbers in a future post.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2.0.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-1.1.2.0.svg&quot; alt=&quot;cowboy-1.1.2.0.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For the load test on cowboy 1.x, the schedulers are slightly under utilized.  I suspect this is primarily due to the HTTP/1.1 protocol itself where TCP connections are not used nearly as efficiently as in HTTP/2.  The extra time is probably spent waiting on I/O.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-2.0.0-rc.1-handler.0.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-2.0.0-rc.1-handler.0.svg&quot; alt=&quot;cowboy-2.0.0-rc.1-handler.0.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;100% scheduler utilization for the duration of the tests.  This is what you might expect to see during a load test.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-2.0.0-rc.1-stream.0.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/cowboy-2.0.0-rc.1-stream.0.svg&quot; alt=&quot;cowboy-2.0.0-rc.1-stream.0.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The stream handler in cowboy 2.x uses a single process per connection.  The previous test, however, uses a single process per stream.  Therefore, the extra 20% of overhead for the previous test may be due to process creation, scheduling, and garbage collection.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/h2o-2.2.0.0.svg&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-20-ac796fcf/h2o-2.2.0.0.svg&quot; alt=&quot;h2o-2.2.0.0.svg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The h2o implementation uses a single process per server.  As shown in the graph, only ~12% scheduler utilization is indicative of only 1 of the 8 normal schedulers being fully utilized.&lt;/p&gt;

&lt;p&gt;The rest of the work is done by h2o in a single non-scheduler thread event loop.&lt;/p&gt;

&lt;p&gt;In a separate implementation not shown here where I spawned a new process for every request (similar to the cowboy 2.x handler), the overall requests per second dropped to ~90k req/s, which is much closer to the performance of cowboy 2.x.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;cowboy 2.x is roughly 2-3x faster than cowboy 1.x based on the above load tests.&lt;/p&gt;

&lt;p&gt;I am still curious, however, as to whether process-per-request alone is the primary cause for the performance degradation when compared to the ~15x faster results of the makeshift h2o NIF.&lt;/p&gt;</content><author><name>Andrew Bennett</name></author><category term="Elixir" /><category term="Erlang" /><category term="HTTP/2" /><category term="Performance" /><summary type="html">Let’s load test cowboy 2.0.0-rc.1 and see how it compares to cowboy 1.1.2!</summary></entry><entry><title type="html">Latency of Native Functions for Erlang and Elixir</title><link href="https://potatosalad.io/2017/08/05/latency-of-native-functions-for-erlang-and-elixir" rel="alternate" type="text/html" title="Latency of Native Functions for Erlang and Elixir" /><published>2017-08-05T00:00:00-05:00</published><updated>2017-08-05T00:00:00-05:00</updated><id>https://potatosalad.io/2017/08/05/latency-of-native-functions-for-erlang-and-elixir</id><content type="html" xml:base="https://potatosalad.io/2017/08/05/latency-of-native-functions-for-erlang-and-elixir">&lt;p&gt;Erlang and C first appeared within 14 years&lt;sup&gt;&lt;a href=&quot;#footnote-post-2017-08-05-b55da7d7-1&quot;&gt;*&lt;/a&gt;&lt;/sup&gt; of one another.&lt;/p&gt;

&lt;p&gt;In the 30+ years together both languages have gone through many changes.  The methods of interoperability have also changed with time.&lt;/p&gt;

&lt;p&gt;There are now &lt;em&gt;several&lt;/em&gt; methods to integrate native functions with Erlang or Elixir code.&lt;/p&gt;

&lt;p&gt;My goal in writing this article is to explore these methods and measure latency from the perspective of the Erlang VM.&lt;/p&gt;

&lt;p&gt;&lt;small&gt;&lt;sup&gt;&lt;a name=&quot;footnote-post-2017-08-05-b55da7d7-1&quot;&gt;*&lt;/a&gt;&lt;/sup&gt; Based on C first appearing in 1972 and Erlang first appearing in 1986.&lt;/small&gt;&lt;/p&gt;

&lt;p&gt;&lt;acronym title=&quot;Too long; didn't read&quot;&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;/acronym&gt; Need a native function (C, C++, Rust, etc.) integrated with Erlang or Elixir that is isolation, complexity, or latency sensitive?&lt;/p&gt;

&lt;p&gt;Having a hard time deciding whether you should write a node, port, port driver, or NIF?&lt;/p&gt;

&lt;p&gt;Use this potentially helpful and fairly unscientific table to help you decide:&lt;/p&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Type&lt;/th&gt;
    &lt;th&gt;Isolation&lt;/th&gt;
    &lt;th&gt;Complexity&lt;/th&gt;
    &lt;th&gt;Latency&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Node&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;Network&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Highest&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Highest&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Port&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Process&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;High&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;High&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Port Driver&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Shared&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Low&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Low&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;NIF&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Shared&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;Lowest&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;Lowest&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;Erlang has an excellent &lt;a href=&quot;http://erlang.org/doc/tutorial/users_guide.html&quot;&gt;Interoperability Tutorial User’s Guide&lt;/a&gt; that provides examples for the different ways of integrating a program written in Erlang or Elixir with a program written in another programming language.&lt;/p&gt;

&lt;p&gt;The simplest test I could think of to measure the latency was to round trip an Erlang term from the Erlang VM to the native function and back again.&lt;/p&gt;

&lt;p&gt;However, the term would need to be large enough to hopefully expose any weaknesses for a given implementation.&lt;/p&gt;

&lt;p&gt;Following the guidance from Erlang’s documentation, I implemented slightly more complex examples of the following methods of interoperability:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/cnode.html&quot;&gt;C Node&lt;/a&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/tree/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/c_node&quot;&gt;C source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/lib/latency/c_node.ex&quot;&gt;Elixir source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/src/latency_c_node.erl&quot;&gt;Erlang source&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/nif.html&quot;&gt;NIF&lt;/a&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/tree/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif&quot;&gt;C source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/lib/latency/nif.ex&quot;&gt;Elixir source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/src/latency_nif.erl&quot;&gt;Erlang source&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/c_portdriver.html&quot;&gt;Port Driver&lt;/a&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/tree/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/drv&quot;&gt;C source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/lib/latency/port_driver.ex&quot;&gt;Elixir source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/src/latency_drv.erl&quot;&gt;Erlang source&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/c_port.html&quot;&gt;Port&lt;/a&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/tree/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/port&quot;&gt;C source&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/lib/latency/port.ex&quot;&gt;Elixir source&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The NIF and Port Driver implementations have a few different internal strategies for additional comparison (like Dirty NIF and &lt;code class=&quot;highlighter-rouge&quot;&gt;iodata()&lt;/code&gt; based port output).&lt;/p&gt;

&lt;p&gt;Certain methods should have higher levels of latency based on serialization and isolation requirements.  For example, a C Node requires serialization of the entire term in order to pass it back and forth over a TCP connection.  A NIF, by comparison, requires no serialization and operates on the term itself in memory.&lt;/p&gt;

&lt;p&gt;Each implementation was tested with a ~64KB binary full of 1’s as the sole element of a 1-arity tuple for 100,000 iterations.  The measured elapsed time for each method were then fed into &lt;a href=&quot;http://hdrhistogram.org/&quot;&gt;HDR Histogram&lt;/a&gt; for latency analysis.&lt;/p&gt;

&lt;p&gt;In other words, I essentially did the following on the &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/lib/latency.ex&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;Latency&lt;/code&gt;&lt;/a&gt; module:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;term&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:binary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)}&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Latency&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compare&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100_000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;c-nodeport-versus-port-drivernif&quot;&gt;C Node/Port versus Port Driver/NIF&lt;/h3&gt;

&lt;p&gt;First, let’s compare the 4 major types of native functions:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart1.png&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart1.png&quot; alt=&quot;chart1&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Comparison of results using the order of magnitude of average latency:&lt;/p&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Type&lt;/th&gt;
    &lt;th&gt;Isolation&lt;/th&gt;
    &lt;th&gt;Latency&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Node&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;Network&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc; text-align: right;&quot;&gt;&lt;tt&gt;~100μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Port&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Process&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc; text-align: right;&quot;&gt;&lt;tt&gt;~100μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Port Driver&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Shared&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~10μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;NIF&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;Shared&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~0.1μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;These tests were run on the same machine, so there’s little surpise that the Node and Port latencies are essentially just benchmarking pipe speeds of the operating system itself (in this case macOS 10.12).  Were the Erlang and C nodes located on different machines, I would expect the latency to be higher for the Node test.&lt;/p&gt;

&lt;p&gt;It’s also worth noting that C Nodes and Ports are the most isolated form of native function calling from the Erlang VM.  This means that a bug in the C code that causes the C Node or Port to crash will not take down the entire VM.&lt;/p&gt;

&lt;h3 id=&quot;port-driver&quot;&gt;Port Driver&lt;/h3&gt;

&lt;p&gt;Port drivers, under certain circumstances, can be roughly as fast as a NIF.  This is especially true for very small terms or when the majority of the work performed is I/O or binary-based.&lt;/p&gt;

&lt;p&gt;The documentation for &lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;driver_entry&lt;/code&gt;&lt;/a&gt; mentions that &lt;a href=&quot;http://erlang.org/doc/man/erlang.html#port_control-3&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;erlang:port_control/3&lt;/code&gt;&lt;/a&gt; should be the fastest way to call a native function.  This seems to be true for very small terms, but larger terms cause the performance to be almost identical to &lt;a href=&quot;http://erlang.org/doc/man/erlang.html#port_call-3&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;erlang:port_call/3&lt;/code&gt;&lt;/a&gt;.  Converting terms to the &lt;a href=&quot;http://erlang.org/doc/apps/erts/erl_ext_dist.html&quot;&gt;External Term Format&lt;/a&gt; and sending with &lt;a href=&quot;http://erlang.org/doc/man/erlang.html#port_command-3&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;erlang:port_command/3&lt;/code&gt;&lt;/a&gt; (which in turn calls the &lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html#outputv&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;outputv&lt;/code&gt;&lt;/a&gt; callback) actually appears to have slightly less latency.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html#call&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;call&lt;/code&gt;&lt;/a&gt; — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/drv/latency_drv.c#L61-L70&quot;&gt;lines 61-70 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_drv.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html#control&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;control&lt;/code&gt;&lt;/a&gt; — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/drv/latency_drv.c#L41-L52&quot;&gt;lines 41-52 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_drv.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html#outputv&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;outputv&lt;/code&gt;&lt;/a&gt; — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/drv/latency_drv.c#L54-L59&quot;&gt;lines 54-59 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_drv.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart2.png&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart2.png&quot; alt=&quot;chart2&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also worth noting is the type of data allowed to be sent to the Port Driver.  For example, &lt;a href=&quot;http://erlang.org/doc/man/erlang.html#port_call-3&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;erlang:port_call/3&lt;/code&gt;&lt;/a&gt; allows terms to be sent, but internally converts them to the external term format.  The other types are similar to C Node and Port implementations and require any terms sent to first be converted.&lt;/p&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Type&lt;/th&gt;
    &lt;th&gt;Data Type&lt;/th&gt;
    &lt;th&gt;Latency&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;call&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;term()&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~15μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;control&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;iodata()&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~15μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;outputv&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;iodata()&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~10μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;h3 id=&quot;nif&quot;&gt;NIF&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html&quot;&gt;Native Implemented Function (NIF)&lt;/a&gt; is a relatively recent addition to OTP and is the fastest way to call native functions.  However, a mis-behaving NIF can easily destabilize or crash the entire Erlang VM.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#dirty_nifs&quot;&gt;Dirty NIF&lt;/a&gt; and Yielding (or Future) NIF with &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#enif_schedule_nif&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;enif_schedule_nif&lt;/code&gt;&lt;/a&gt; are even more recent additions that help prevent blocking the Erlang VM schedulers during execution or (in the case of I/O) waiting.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Dirty CPU — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L20-L24&quot;&gt;lines 20-24 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Dirty I/O — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L26-L30&quot;&gt;lines 26-30 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Future — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L32-L36&quot;&gt;lines 32-36 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Normal — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L14-L18&quot;&gt;lines 14-18 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart3.png&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart3.png&quot; alt=&quot;chart3&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The Normal NIF call is the only one that doesn’t have any sort of context switching involved.  The Yielding (or Future) NIF also doesn’t involve much of a context switch as it yields control back to the same scheduler that dispatched the call.  Dirty NIF calls, however, result in a ~2μs context switch delay as the function gets enqueued on the dirty thread pool.&lt;/p&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Type&lt;/th&gt;
    &lt;th&gt;Context Switch&lt;/th&gt;
    &lt;th&gt;Latency&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Dirty CPU&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Thread Queue&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~2.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Dirty I/O&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Thread Queue&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~2.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Future&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Yield&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~0.5μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Normal&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc;&quot;&gt;&lt;tt&gt;None&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~0.1μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;Just for fun, I was curious about the latency differences between the new Dirty NIF functionality and the previous method of using a Threaded NIF or the Async NIF (or Thread Queue) by &lt;a href=&quot;https://github.com/gburd&quot;&gt;Gregory Burd&lt;/a&gt;.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Thread New — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L38-L72&quot;&gt;lines 38-72 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Thread Queue — &lt;a href=&quot;https://github.com/potatosalad/elixirconf2017/blob/555763cd7505bf1ffcaa7c7099161a9e74c63a3f/apps/latency/c_src/nif/latency_nif.c#L74-L90&quot;&gt;lines 74-90 of &lt;code class=&quot;highlighter-rouge&quot;&gt;latency_nif.c&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a href=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart4.png&quot;&gt;&lt;img src=&quot;https://potatosalad.io/assets/post-2017-08-05-b55da7d7/chart4.png&quot; alt=&quot;chart4&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As it turns out, creating and destroying a thread for each and every call is unwise for a few reasons; poor latency being one of them.  The Async NIF (or Thread Queue) has the advantage of providing a pool per NIF instead of having to share the global thread pool with other NIFs.  However, Dirty NIF thread pools are definitely more optimized and are typically 4x faster than the Async NIF implementation.&lt;/p&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Type&lt;/th&gt;
    &lt;th&gt;Pool Type&lt;/th&gt;
    &lt;th&gt;Latency&lt;/th&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Thread New&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc;&quot;&gt;&lt;tt&gt;None&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #fcc; text-align: right;&quot;&gt;&lt;tt&gt;~50.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Thread Queue&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;NIF&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc; text-align: right;&quot;&gt;&lt;tt&gt;~8.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Dirty CPU&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Global&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~2.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;tt&gt;Dirty I/O&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #ffc;&quot;&gt;&lt;tt&gt;Global&lt;/tt&gt;&lt;/td&gt;
    &lt;td style=&quot;background-color: #cfc; text-align: right;&quot;&gt;&lt;tt&gt;~2.0μs&lt;/tt&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;

&lt;h3 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h3&gt;

&lt;p&gt;If isolation from/protection of the Erlang VM is highest priority, a C Node or Port are your best options.  If your primary concern is low latency or low complexity, using a NIF for your native function is your best option.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;As a side note:&lt;/em&gt; For very specific I/O operations, a Port Driver still may be the best option.  OTP-20 has the new &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#enif_select&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;enif_select&lt;/code&gt;&lt;/a&gt;, which is starting to transition some of those I/O benefits to the NIF world, so this may not be true statement in the near future.&lt;/p&gt;</content><author><name>Andrew Bennett</name></author><category term="C" /><category term="Elixir" /><category term="Erlang" /><category term="Performance" /><summary type="html">Erlang and C first appeared within 14 years* of one another.</summary></entry><entry><title type="html">Erlang NIF with timeslice reductions</title><link href="https://potatosalad.io/2016/02/06/erlang-nif-with-timeslice-reductions" rel="alternate" type="text/html" title="Erlang NIF with timeslice reductions" /><published>2016-02-06T00:00:00-06:00</published><updated>2016-02-06T00:00:00-06:00</updated><id>https://potatosalad.io/2016/02/06/erlang-nif-with-timeslice-reductions</id><content type="html" xml:base="https://potatosalad.io/2016/02/06/erlang-nif-with-timeslice-reductions">&lt;p&gt;Recently, I put together an Erlang asynchronous port driver named &lt;a href=&quot;https://github.com/potatosalad/erlang-keccakf1600&quot;&gt;keccakf1600&lt;/a&gt; which implements the &lt;a href=&quot;https://en.wikipedia.org/wiki/SHA-3&quot;&gt;SHA-3&lt;/a&gt; algorithms used in another one of my projects, &lt;a href=&quot;https://github.com/potatosalad/erlang-jose&quot;&gt;jose&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;See version &lt;a href=&quot;https://github.com/potatosalad/erlang-keccakf1600/tree/1.0.2&quot;&gt;1.0.2 of keccakf1600&lt;/a&gt; for the original port driver implementation.&lt;/p&gt;

&lt;p&gt;When interfacing with native C and the Erlang VM, you essentially have 3 options to choose from:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/c_portdriver.html&quot;&gt;Port Driver&lt;/a&gt; — a shared library linked with &lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;driver_entry&lt;/code&gt;&lt;/a&gt; (I/O heavy operations are typically best suited for this type)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/nif.html&quot;&gt;NIF&lt;/a&gt; — a shared library linked with &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ERL_NIF_INIT&lt;/code&gt;&lt;/a&gt; (fast synchronous operations are typically best suited for this type)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://erlang.org/doc/tutorial/c_port.html&quot;&gt;Port&lt;/a&gt; — an external program which typically communicates with the Erlang VM over &lt;code class=&quot;highlighter-rouge&quot;&gt;stdin&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;stdout&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;My goal was to have a fast and asynchronous way to call blocking functions without disrupting the Erlang VM schedulers from carrying out their work.  The original plan was to use &lt;a href=&quot;http://erlang.org/doc/man/erl_driver.html#driver_async%20&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;driver_async&lt;/code&gt;&lt;/a&gt; combined with &lt;a href=&quot;http://erlang.org/doc/man/driver_entry.html#ready_async&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ready_async&lt;/code&gt;&lt;/a&gt; to perform the blocking operations on “a thread separate from the emulator thread.”  I used the &lt;a href=&quot;http://erlang.org/doc/man/ei.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ei&lt;/code&gt;&lt;/a&gt; library in order to communicate between the Erlang VM and the port driver written in C.&lt;/p&gt;

&lt;p&gt;Having accomplished my goal, I decided to run a simple benchmark against the equivalent SHA-2 algorithms out of curiosity as to how my implementation might stack up against the native Erlang &lt;a href=&quot;http://erlang.org/doc/man/crypto.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;crypto&lt;/code&gt;&lt;/a&gt; library.&lt;/p&gt;

&lt;p&gt;The results were not terribly impressive:&lt;/p&gt;

&lt;div id=&quot;post-2016-02-06-ae71986a-chart1&quot;&gt;
  &lt;img src=&quot;https://potatosalad.io/assets/post-2016-02-06-ae71986a/chart1.svg&quot; style=&quot;width:100%;height:100%;&quot; /&gt;
  &lt;svg height=&quot;300&quot;&gt;&lt;/svg&gt;
&lt;/div&gt;

&lt;p&gt;The two main concerns I had with the results were:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Was the SHA-3 implementation I used (based on &lt;a href=&quot;http://sourceforge.net/projects/ed448goldilocks/&quot;&gt;ed448goldilocks&lt;/a&gt;) really 5-7 times slower than the SHA-2 algorithms?&lt;/li&gt;
  &lt;li&gt;Why was there so much variance between the SHA-3 algorithms versus the variance observed between the SHA-2 algorithms?&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Concern #1 was ruled out by directly testing the C version of the algorithms, for small message sizes they were typically within 1-2μs of each other.&lt;/p&gt;

&lt;p&gt;Concern #2 required more research, which eventually led me to the &lt;a href=&quot;https://github.com/vinoski/bitwise&quot;&gt;bitwise&lt;/a&gt; project by Steve Vinoski.  The project explores some of the strategies for dealing with the synchronous nature of a NIF without blocking the scheduler by keeping track of reductions during a given &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#enif_consume_timeslice&quot;&gt;timeslice&lt;/a&gt;.  It also explores strategies using the experimental &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#dirty_nifs&quot;&gt;dirty NIF&lt;/a&gt; feature.&lt;/p&gt;

&lt;p&gt;I highly recommend reading the two presentations from the bitwise project: &lt;a href=&quot;https://github.com/vinoski/bitwise/raw/master/vinoski-opt-native-code.pdf&quot;&gt;vinoski-opt-native-code.pdf&lt;/a&gt; and &lt;a href=&quot;https://github.com/vinoski/bitwise/raw/master/vinoski-schedulers.pdf&quot;&gt;vinoski-schedulers.pdf&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After experimenting with the two options, I decided to use &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#enif_consume_timeslice&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;enif_consume_timeslice&lt;/code&gt;&lt;/a&gt; combined with &lt;a href=&quot;http://erlang.org/doc/man/erl_nif.html#enif_schedule_nif&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;enif_schedule_nif&lt;/code&gt;&lt;/a&gt; to yield control back to the main Erlang VM on larger inputs to prevent blocking other schedulers.&lt;/p&gt;

&lt;p&gt;I rewrote the port driver as a NIF and released it as version &lt;a href=&quot;https://github.com/potatosalad/erlang-keccakf1600/tree/2.0.0&quot;&gt;2.0.0 of keccakf1600&lt;/a&gt; and ran the same benchmark again:&lt;/p&gt;

&lt;div id=&quot;post-2016-02-06-ae71986a-chart2&quot;&gt;
  &lt;img src=&quot;https://potatosalad.io/assets/post-2016-02-06-ae71986a/chart2.svg&quot; style=&quot;width:100%;height:100%;&quot; /&gt;
  &lt;svg height=&quot;300&quot;&gt;&lt;/svg&gt;
&lt;/div&gt;

&lt;p&gt;These results are much more consistent and closer to my original expectations.  I plan on refactoring the &lt;a href=&quot;https://github.com/potatosalad/erlang-libsodium&quot;&gt;erlang-libsodium&lt;/a&gt; project using the same technique.&lt;/p&gt;

&lt;script&gt;
(function() {
  var nvd3Supported = false;
  if (typeof window.nv !== 'undefined' &amp;&amp; typeof window.d3 !== 'undefined') {
    nvd3Supported = true;
  }
  if (!nvd3Supported) {
    var chart1Image = document.querySelector('#post-2016-02-06-ae71986a-chart1 &gt; img');
    if (chart1Image !== null &amp;&amp; chart1Image.style !== null) {
      chart1Image.style.display = 'none';
    }
    var chart2Image = document.querySelector('#post-2016-02-06-ae71986a-chart2 &gt; img');
    if (chart2Image !== null &amp;&amp; chart2Image.style !== null) {
      chart2Image.style.display = 'none';
    }
    var seriesData1 = [
      {
        key: &quot;SHA2&quot;,
        values: [
          {
            label: &quot;SHA2/3-224&quot;,
            value: 2.186853
          },
          {
            label: &quot;SHA2/3-256&quot;,
            value: 2.183836
          },
          {
            label: &quot;SHA2/3-384&quot;,
            value: 2.190898
          },
          {
            label: &quot;SHA2/3-512&quot;,
            value: 2.200743
          }
        ]
      },
      {
        key: &quot;SHA3&quot;,
        values: [
          {
            label: &quot;SHA2/3-224&quot;,
            value: 14.37063
          },
          {
            label: &quot;SHA2/3-256&quot;,
            value: 11.97354
          },
          {
            label: &quot;SHA2/3-384&quot;,
            value: 12.42217
          },
          {
            label: &quot;SHA2/3-512&quot;,
            value: 11.8663
          },
          {
            label: &quot;SHAKE128&quot;,
            value: 12.38027
          },
          {
            label: &quot;SHAKE256&quot;,
            value: 12.96572
          }
        ]
      }
    ];
    nv.addGraph(function() {
      var chart = nv.models.multiBarHorizontalChart()
        .x(function(d) { return d.label; })
        .y(function(d) { return d.value; })
        .margin({left: 100, bottom: 75})
        .barColor(d3.scale.category20().range())
        .showValues(true)
        .duration(250)
        .showControls(false)
      ;
      chart.yAxis.axisLabel('Microseconds (Lower is Better)');
      d3.select(&quot;#post-2016-02-06-ae71986a-chart1 svg&quot;)
        .datum(seriesData1)
        .call(chart);
      nv.utils.windowResize(chart.update);
      return chart;
    });
    var seriesData2 = [
      {
        key: &quot;SHA2&quot;,
        values: [
          {
            label: &quot;SHA2/3-224&quot;,
            value: 2.186853
          },
          {
            label: &quot;SHA2/3-256&quot;,
            value: 2.183836
          },
          {
            label: &quot;SHA2/3-384&quot;,
            value: 2.190898
          },
          {
            label: &quot;SHA2/3-512&quot;,
            value: 2.200743
          }
        ]
      },
      {
        key: &quot;SHA3&quot;,
        values: [
          {
            label: &quot;SHA2/3-224&quot;,
            value: 3.221057
          },
          {
            label: &quot;SHA2/3-256&quot;,
            value: 3.222021
          },
          {
            label: &quot;SHA2/3-384&quot;,
            value: 3.200662
          },
          {
            label: &quot;SHA2/3-512&quot;,
            value: 3.222704
          },
          {
            label: &quot;SHAKE128&quot;,
            value: 3.228499
          },
          {
            label: &quot;SHAKE256&quot;,
            value: 3.257091
          }
        ]
      }
    ];
    nv.addGraph(function() {
      var chart = nv.models.multiBarHorizontalChart()
        .x(function(d) { return d.label; })
        .y(function(d) { return d.value; })
        .margin({left: 100, bottom: 75})
        .barColor(d3.scale.category20().range())
        .showValues(true)
        .duration(250)
        .showControls(false)
      ;
      chart.yAxis.axisLabel('Microseconds (Lower is Better)');
      d3.select(&quot;#post-2016-02-06-ae71986a-chart2 svg&quot;)
        .datum(seriesData2)
        .call(chart);
      nv.utils.windowResize(chart.update);
      return chart;
    });
  } else {
    var chart1Svg = document.querySelector('#post-2016-02-06-ae71986a-chart1 &gt; svg');
    if (chart1Svg !== null &amp;&amp; chart1Svg.style !== null) {
      chart1Svg.style.display = 'none';
    }
    var chart2Svg = document.querySelector('#post-2016-02-06-ae71986a-chart2 &gt; svg');
    if (chart2Svg !== null &amp;&amp; chart2Svg.style !== null) {
      chart2Svg.style.display = 'none';
    }
  }
})();
&lt;/script&gt;</content><author><name>Andrew Bennett</name></author><category term="C" /><category term="Elixir" /><category term="Erlang" /><summary type="html">Recently, I put together an Erlang asynchronous port driver named keccakf1600 which implements the SHA-3 algorithms used in another one of my projects, jose.</summary></entry></feed>